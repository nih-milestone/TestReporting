name: 'Test reporting'

on:
  push:
  workflow_dispatch:
  
permissions:
  contents: read
  actions: read
  checks: write  
  
jobs:
  build-and-test:
    name: 'Build, test and report'
    runs-on: windows-latest
    
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: 'Parse - Failing results'
        if: false
        uses: nih-milestone/trx-parser@v0.5.7
        with:
          TRX_PATH: ${{ github.workspace }}\FailingTestResults
          TRX_GROUPING: 50
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
          
      - name: 'Parse - Passing results'
        if: false
        uses: nih-milestone/trx-parser@v0.5.7
        with:
          TRX_PATH: ${{ github.workspace }}\PassingTestResults
          TRX_GROUPING: 50
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set current date as env variable
        run: echo "NOW=$([DateTime]::UtcNow.ToString('o'))" >> $GITHUB_ENV          

      - name: Create Check Run
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
            gh api -X POST -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -f 'name=A Mighty Test' \
            -f 'head_sha=${{ github.sha }}' \
            -f 'status=in_progress' \
            -f 'output[title]=A Mighty Summary - ${{ github.run_id }} - ${{ env.NOW }}' \
            /repos/${{ github.repository }}/check-runs             